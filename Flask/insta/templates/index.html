<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram</title>
</head>
<body>
    <h1> Instagram API Test</h1>
    <form onsubmit="fetchUsers(event)">
        <button type="submit">Fetch users</button> 
    </form>

    <h2> Create User </h2>

    <form id="createUserForm" onsubmit="createUser(event)">
        <input type="text" placeholder="Username" /> <button type="submit">Create User</button> 
    </form>

    <br>

    <h2> Add Post User </h2>

    <form id="addPostForm" onsubmit="addPost(event)">
        <input type="text" placeholder="Username" /> <input type="text" placeholder="Post Title" />
        <button type="submit">Add Post</button> 
    </form>
    <br>


    <h2> Delete User </h2>
    <form id="deleteUserForm" onsubmit="deleteUser(event)">
        <input type="text" placeholder="Username" /> <button type="submit">Delete User</button>
    </form>

    <script>
        async function fetchUsers() {
            const response = await fetch('/users');
            const users = await response.json();
            // const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';

            users.forEach(user => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<strong>${user.username}</strong>`;
                const postList = document.createElement('ul');
                
                user.posts.forEach(post => {
                    const postItem = document.createElement('li');
                    postItem.textContent = `${post.title} (Likes: ${post.likes})`;
                    postList.appendChild(postItem);
                });

                listItem.appendChild(postList);
                usersList.appendChild(listItem);
            });
        }

        async function createUser(event) {
            event.preventDefault();
            const formData = new FormData(document.getElementById('createUserForm'));
            const response = await fetch('/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: formData.get('username') })
            });
            if (response.ok) fetchUsers();
        }

        async function addPost(event) {
            event.preventDefault();
            const formData = new FormData(document.getElementById('addPostForm'));
            const response = await fetch('/users/post', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    username: formData.get('username'), 
                    title: formData.get('title') 
                })
            });
            if (response.ok) fetchUsers();
        }

        async function deleteUser(event) {
            event.preventDefault();
            const formData = new FormData(document.getElementById('deleteUserForm'));
            const username = formData.get('username');
            const response = await fetch(`/users/${username}`, {
                method: 'DELETE'
            });
            if (response.ok) fetchUsers();
        }

        // 페이지 로드 시 사용자 목록을 불러옵니다.
        window.onload = fetchUsers;
    </script>
</body>
</html>